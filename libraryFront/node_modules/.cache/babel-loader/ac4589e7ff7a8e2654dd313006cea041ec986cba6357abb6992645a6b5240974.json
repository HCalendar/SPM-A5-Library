{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { nextTick } from 'vue';\nimport { on, off } from '../../utils/dom.mjs';\nimport { EVENT_CODE, obtainAllFocusableElements } from '../../utils/aria.mjs';\nconst FOCUSABLE_CHILDREN = \"_trap-focus-children\";\nconst TRAP_FOCUS_HANDLER = \"_trap-focus-handler\";\nconst FOCUS_STACK = [];\nconst FOCUS_HANDLER = e => {\n  var _a;\n  if (FOCUS_STACK.length === 0) return;\n  const focusableElement = FOCUS_STACK[FOCUS_STACK.length - 1][FOCUSABLE_CHILDREN];\n  if (focusableElement.length > 0 && e.code === EVENT_CODE.tab) {\n    if (focusableElement.length === 1) {\n      e.preventDefault();\n      if (document.activeElement !== focusableElement[0]) {\n        focusableElement[0].focus();\n      }\n      return;\n    }\n    const goingBackward = e.shiftKey;\n    const isFirst = e.target === focusableElement[0];\n    const isLast = e.target === focusableElement[focusableElement.length - 1];\n    if (isFirst && goingBackward) {\n      e.preventDefault();\n      focusableElement[focusableElement.length - 1].focus();\n    }\n    if (isLast && !goingBackward) {\n      e.preventDefault();\n      focusableElement[0].focus();\n    }\n    if (process.env.NODE_ENV === \"test\") {\n      const index = focusableElement.findIndex(element => element === e.target);\n      if (index !== -1) {\n        (_a = focusableElement[goingBackward ? index - 1 : index + 1]) == null ? void 0 : _a.focus();\n      }\n    }\n  }\n};\nconst TrapFocus = {\n  beforeMount(el) {\n    el[FOCUSABLE_CHILDREN] = obtainAllFocusableElements(el);\n    FOCUS_STACK.push(el);\n    if (FOCUS_STACK.length <= 1) {\n      on(document, \"keydown\", FOCUS_HANDLER);\n    }\n  },\n  updated(el) {\n    nextTick(() => {\n      el[FOCUSABLE_CHILDREN] = obtainAllFocusableElements(el);\n    });\n  },\n  unmounted() {\n    FOCUS_STACK.shift();\n    if (FOCUS_STACK.length === 0) {\n      off(document, \"keydown\", FOCUS_HANDLER);\n    }\n  }\n};\nexport { FOCUSABLE_CHILDREN, TRAP_FOCUS_HANDLER, TrapFocus as default };","map":{"version":3,"names":["FOCUSABLE_CHILDREN","TRAP_FOCUS_HANDLER","FOCUS_STACK","FOCUS_HANDLER","e","_a","length","focusableElement","code","EVENT_CODE","tab","preventDefault","document","activeElement","focus","goingBackward","shiftKey","isFirst","target","isLast","process","env","NODE_ENV","index","findIndex","element","TrapFocus","beforeMount","el","obtainAllFocusableElements","push","on","updated","nextTick","unmounted","shift","off"],"sources":["../../../../../packages/directives/trap-focus/index.ts"],"sourcesContent":["import { nextTick } from 'vue'\nimport { on, off } from '@element-plus/utils/dom'\nimport {\n  obtainAllFocusableElements,\n  EVENT_CODE,\n} from '@element-plus/utils/aria'\n\nimport type { ObjectDirective } from 'vue'\n\nexport const FOCUSABLE_CHILDREN = '_trap-focus-children'\nexport const TRAP_FOCUS_HANDLER = '_trap-focus-handler'\n\nexport interface ITrapFocusElement extends HTMLElement {\n  [FOCUSABLE_CHILDREN]: HTMLElement[]\n  [TRAP_FOCUS_HANDLER]: (e: KeyboardEvent) => void\n}\n\nconst FOCUS_STACK = []\n\nconst FOCUS_HANDLER = (e: KeyboardEvent) => {\n  // Getting the top layer.\n  if (FOCUS_STACK.length === 0) return\n  const focusableElement =\n    FOCUS_STACK[FOCUS_STACK.length - 1][FOCUSABLE_CHILDREN]\n  if (focusableElement.length > 0 && e.code === EVENT_CODE.tab) {\n    if (focusableElement.length === 1) {\n      e.preventDefault()\n      if (document.activeElement !== focusableElement[0]) {\n        focusableElement[0].focus()\n      }\n      return\n    }\n    const goingBackward = e.shiftKey\n    const isFirst = e.target === focusableElement[0]\n    const isLast = e.target === focusableElement[focusableElement.length - 1]\n    if (isFirst && goingBackward) {\n      e.preventDefault()\n      focusableElement[focusableElement.length - 1].focus()\n    }\n    if (isLast && !goingBackward) {\n      e.preventDefault()\n      focusableElement[0].focus()\n    }\n\n    // the is critical since jsdom did not implement user actions, you can only mock it\n    // DELETE ME: when testing env switches to puppeteer\n    if (process.env.NODE_ENV === 'test') {\n      const index = focusableElement.findIndex(\n        (element: Element) => element === e.target\n      )\n      if (index !== -1) {\n        focusableElement[goingBackward ? index - 1 : index + 1]?.focus()\n      }\n    }\n  }\n}\n\nconst TrapFocus: ObjectDirective = {\n  beforeMount(el: ITrapFocusElement) {\n    el[FOCUSABLE_CHILDREN] = obtainAllFocusableElements(el)\n    FOCUS_STACK.push(el)\n    if (FOCUS_STACK.length <= 1) {\n      on(document, 'keydown', FOCUS_HANDLER)\n    }\n  },\n  updated(el: ITrapFocusElement) {\n    nextTick(() => {\n      el[FOCUSABLE_CHILDREN] = obtainAllFocusableElements(el)\n    })\n  },\n  unmounted() {\n    FOCUS_STACK.shift()\n    if (FOCUS_STACK.length === 0) {\n      off(document, 'keydown', FOCUS_HANDLER)\n    }\n  },\n}\n\nexport default TrapFocus\n"],"mappings":";;;;MASaA,kBAAA,GAAqB;MACrBC,kBAAA,GAAqB;AAOlC,MAAMC,WAAA,GAAc;AAEpB,MAAMC,aAAA,GAAiBC,CAAA,IAAqB;EAnB5C,IAAAC,EAAA;EAqBE,IAAIH,WAAA,CAAYI,MAAA,KAAW,GAAG;EAC9B,MAAMC,gBAAA,GACJL,WAAA,CAAYA,WAAA,CAAYI,MAAA,GAAS,GAAGN,kBAAA;EACtC,IAAIO,gBAAA,CAAiBD,MAAA,GAAS,KAAKF,CAAA,CAAEI,IAAA,KAASC,UAAA,CAAWC,GAAA,EAAK;IAC5D,IAAIH,gBAAA,CAAiBD,MAAA,KAAW,GAAG;MACjCF,CAAA,CAAEO,cAAA;MACF,IAAIC,QAAA,CAASC,aAAA,KAAkBN,gBAAA,CAAiB,IAAI;QAClDA,gBAAA,CAAiB,GAAGO,KAAA;MAAA;MAEtB;IAAA;IAEF,MAAMC,aAAA,GAAgBX,CAAA,CAAEY,QAAA;IACxB,MAAMC,OAAA,GAAUb,CAAA,CAAEc,MAAA,KAAWX,gBAAA,CAAiB;IAC9C,MAAMY,MAAA,GAASf,CAAA,CAAEc,MAAA,KAAWX,gBAAA,CAAiBA,gBAAA,CAAiBD,MAAA,GAAS;IACvE,IAAIW,OAAA,IAAWF,aAAA,EAAe;MAC5BX,CAAA,CAAEO,cAAA;MACFJ,gBAAA,CAAiBA,gBAAA,CAAiBD,MAAA,GAAS,GAAGQ,KAAA;IAAA;IAEhD,IAAIK,MAAA,IAAU,CAACJ,aAAA,EAAe;MAC5BX,CAAA,CAAEO,cAAA;MACFJ,gBAAA,CAAiB,GAAGO,KAAA;IAAA;IAKtB,IAAIM,OAAA,CAAQC,GAAA,CAAIC,QAAA,KAAa,QAAQ;MACnC,MAAMC,KAAA,GAAQhB,gBAAA,CAAiBiB,SAAA,CAC5BC,OAAA,IAAqBA,OAAA,KAAYrB,CAAA,CAAEc,MAAA;MAEtC,IAAIK,KAAA,KAAU,IAAI;QAChB,CAAAlB,EAAA,GAAAE,gBAAA,CAAiBQ,aAAA,GAAgBQ,KAAA,GAAQ,IAAIA,KAAA,GAAQ,OAArD,gBAAAlB,EAAA,CAAyDS,KAAA;MAAA;IAAA;EAAA;AAAA;MAM3DY,SAAA,GAA6B;EACjCC,YAAYC,EAAA,EAAuB;IACjCA,EAAA,CAAG5B,kBAAA,IAAsB6B,0BAAA,CAA2BD,EAAA;IACpD1B,WAAA,CAAY4B,IAAA,CAAKF,EAAA;IACjB,IAAI1B,WAAA,CAAYI,MAAA,IAAU,GAAG;MAC3ByB,EAAA,CAAGnB,QAAA,EAAU,WAAWT,aAAA;IAAA;EAAA;EAG5B6B,QAAQJ,EAAA,EAAuB;IAC7BK,QAAA,CAAS,MAAM;MACbL,EAAA,CAAG5B,kBAAA,IAAsB6B,0BAAA,CAA2BD,EAAA;IAAA;EAAA;EAGxDM,UAAA,EAAY;IACVhC,WAAA,CAAYiC,KAAA;IACZ,IAAIjC,WAAA,CAAYI,MAAA,KAAW,GAAG;MAC5B8B,GAAA,CAAIxB,QAAA,EAAU,WAAWT,aAAA;IAAA;EAAA;AAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}