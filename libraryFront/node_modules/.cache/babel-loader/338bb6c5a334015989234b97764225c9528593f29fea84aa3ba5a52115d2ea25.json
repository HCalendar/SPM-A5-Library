{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport isServer from './isServer.mjs';\nimport { getConfig } from './config.mjs';\nimport { on, addClass, removeClass } from './dom.mjs';\nimport { EVENT_CODE } from './aria.mjs';\nconst onTouchMove = e => {\n  e.preventDefault();\n  e.stopPropagation();\n};\nconst onModalClick = () => {\n  PopupManager == null ? void 0 : PopupManager.doOnModalClick();\n};\nlet hasModal = false;\nlet zIndex;\nconst getModal = function () {\n  if (isServer) return;\n  let modalDom = PopupManager.modalDom;\n  if (modalDom) {\n    hasModal = true;\n  } else {\n    hasModal = false;\n    modalDom = document.createElement(\"div\");\n    PopupManager.modalDom = modalDom;\n    on(modalDom, \"touchmove\", onTouchMove);\n    on(modalDom, \"click\", onModalClick);\n  }\n  return modalDom;\n};\nconst instances = {};\nconst PopupManager = {\n  modalFade: true,\n  modalDom: void 0,\n  zIndex,\n  getInstance(id) {\n    return instances[id];\n  },\n  register(id, instance) {\n    if (id && instance) {\n      instances[id] = instance;\n    }\n  },\n  deregister(id) {\n    if (id) {\n      instances[id] = null;\n      delete instances[id];\n    }\n  },\n  nextZIndex() {\n    return ++PopupManager.zIndex;\n  },\n  modalStack: [],\n  doOnModalClick() {\n    const topItem = PopupManager.modalStack[PopupManager.modalStack.length - 1];\n    if (!topItem) return;\n    const instance = PopupManager.getInstance(topItem.id);\n    if (instance && instance.closeOnClickModal.value) {\n      instance.close();\n    }\n  },\n  openModal(id, zIndex2, dom, modalClass, modalFade) {\n    if (isServer) return;\n    if (!id || zIndex2 === void 0) return;\n    this.modalFade = modalFade;\n    const modalStack = this.modalStack;\n    for (let i = 0, j = modalStack.length; i < j; i++) {\n      const item = modalStack[i];\n      if (item.id === id) {\n        return;\n      }\n    }\n    const modalDom = getModal();\n    addClass(modalDom, \"v-modal\");\n    if (this.modalFade && !hasModal) {\n      addClass(modalDom, \"v-modal-enter\");\n    }\n    if (modalClass) {\n      const classArr = modalClass.trim().split(/\\s+/);\n      classArr.forEach(item => addClass(modalDom, item));\n    }\n    setTimeout(() => {\n      removeClass(modalDom, \"v-modal-enter\");\n    }, 200);\n    if (dom && dom.parentNode && dom.parentNode.nodeType !== 11) {\n      dom.parentNode.appendChild(modalDom);\n    } else {\n      document.body.appendChild(modalDom);\n    }\n    if (zIndex2) {\n      modalDom.style.zIndex = String(zIndex2);\n    }\n    modalDom.tabIndex = 0;\n    modalDom.style.display = \"\";\n    this.modalStack.push({\n      id,\n      zIndex: zIndex2,\n      modalClass\n    });\n  },\n  closeModal(id) {\n    const modalStack = this.modalStack;\n    const modalDom = getModal();\n    if (modalStack.length > 0) {\n      const topItem = modalStack[modalStack.length - 1];\n      if (topItem.id === id) {\n        if (topItem.modalClass) {\n          const classArr = topItem.modalClass.trim().split(/\\s+/);\n          classArr.forEach(item => removeClass(modalDom, item));\n        }\n        modalStack.pop();\n        if (modalStack.length > 0) {\n          modalDom.style.zIndex = modalStack[modalStack.length - 1].zIndex;\n        }\n      } else {\n        for (let i = modalStack.length - 1; i >= 0; i--) {\n          if (modalStack[i].id === id) {\n            modalStack.splice(i, 1);\n            break;\n          }\n        }\n      }\n    }\n    if (modalStack.length === 0) {\n      if (this.modalFade) {\n        addClass(modalDom, \"v-modal-leave\");\n      }\n      setTimeout(() => {\n        if (modalStack.length === 0) {\n          if (modalDom.parentNode) modalDom.parentNode.removeChild(modalDom);\n          modalDom.style.display = \"none\";\n          PopupManager.modalDom = void 0;\n        }\n        removeClass(modalDom, \"v-modal-leave\");\n      }, 200);\n    }\n  }\n};\nObject.defineProperty(PopupManager, \"zIndex\", {\n  configurable: true,\n  get() {\n    if (zIndex === void 0) {\n      zIndex = getConfig(\"zIndex\") || 2e3;\n    }\n    return zIndex;\n  },\n  set(value) {\n    zIndex = value;\n  }\n});\nconst getTopPopup = function () {\n  if (isServer) return;\n  if (PopupManager.modalStack.length > 0) {\n    const topPopup = PopupManager.modalStack[PopupManager.modalStack.length - 1];\n    if (!topPopup) return;\n    const instance = PopupManager.getInstance(topPopup.id);\n    return instance;\n  }\n};\nif (!isServer) {\n  on(window, \"keydown\", function (event) {\n    if (event.code === EVENT_CODE.esc) {\n      const topPopup = getTopPopup();\n      if (topPopup && topPopup.closeOnPressEscape.value) {\n        topPopup.handleClose ? topPopup.handleClose() : topPopup.handleAction ? topPopup.handleAction(\"cancel\") : topPopup.close();\n      }\n    }\n  });\n}\nexport { PopupManager as default };","map":{"version":3,"names":["onTouchMove","e","preventDefault","stopPropagation","onModalClick","PopupManager","doOnModalClick","hasModal","zIndex","getModal","isServer","modalDom","document","createElement","on","instances","modalFade","getInstance","id","register","instance","deregister","nextZIndex","modalStack","topItem","length","closeOnClickModal","value","close","openModal","zIndex2","dom","modalClass","i","j","item","addClass","classArr","trim","split","forEach","setTimeout","removeClass","parentNode","nodeType","appendChild","body","style","String","tabIndex","display","push","closeModal","pop","splice","removeChild","Object","defineProperty","configurable","get","getConfig","set","getTopPopup","topPopup","window","event","code","EVENT_CODE","esc","closeOnPressEscape","handleClose","handleAction"],"sources":["../../../../packages/utils/popup-manager.ts"],"sourcesContent":["import isServer from './isServer'\nimport * as configs from './config'\nimport { addClass, removeClass, on } from './dom'\nimport { EVENT_CODE } from './aria'\n\nimport type { Ref } from 'vue'\ninterface Instance {\n  closeOnClickModal: Ref<boolean>\n  closeOnPressEscape: Ref<boolean>\n  close: () => void\n  handleClose?: () => void\n  handleAction?: (action: string) => void\n}\n\ntype StackFrame = { id: string; zIndex: number; modalClass: string }\n\ninterface IPopupManager {\n  getInstance: (id: string) => Instance\n  zIndex: number\n  modalDom?: HTMLElement\n  modalFade: boolean\n  modalStack: StackFrame[]\n  nextZIndex: () => number\n  register: (id: string, instance: Instance) => void\n  deregister: (id: string) => void\n  doOnModalClick: () => void\n  openModal: (\n    id: string,\n    zIndex: number,\n    dom: HTMLElement,\n    modalClass: string,\n    modalFade: boolean\n  ) => void\n  closeModal: (id: string) => void\n}\n\nconst onTouchMove = (e: Event) => {\n  e.preventDefault()\n  e.stopPropagation()\n}\n\nconst onModalClick = () => {\n  PopupManager?.doOnModalClick()\n}\n\nlet hasModal = false\nlet zIndex: number\n\nconst getModal = function (): HTMLElement {\n  if (isServer) return\n  let modalDom = PopupManager.modalDom\n  if (modalDom) {\n    hasModal = true\n  } else {\n    hasModal = false\n    modalDom = document.createElement('div')\n    PopupManager.modalDom = modalDom\n\n    on(modalDom, 'touchmove', onTouchMove)\n    on(modalDom, 'click', onModalClick)\n  }\n\n  return modalDom\n}\n\nconst instances = {}\n\nconst PopupManager: IPopupManager = {\n  modalFade: true,\n  modalDom: undefined,\n  zIndex,\n\n  getInstance(id) {\n    return instances[id]\n  },\n\n  register(id, instance) {\n    if (id && instance) {\n      instances[id] = instance\n    }\n  },\n\n  deregister(id) {\n    if (id) {\n      instances[id] = null\n      delete instances[id]\n    }\n  },\n\n  nextZIndex() {\n    return ++PopupManager.zIndex\n  },\n\n  modalStack: [],\n\n  doOnModalClick() {\n    const topItem = PopupManager.modalStack[PopupManager.modalStack.length - 1]\n    if (!topItem) return\n\n    const instance = PopupManager.getInstance(topItem.id)\n    if (instance && instance.closeOnClickModal.value) {\n      instance.close()\n    }\n  },\n\n  openModal(id, zIndex, dom, modalClass, modalFade) {\n    if (isServer) return\n    if (!id || zIndex === undefined) return\n    this.modalFade = modalFade\n\n    const modalStack = this.modalStack\n\n    for (let i = 0, j = modalStack.length; i < j; i++) {\n      const item = modalStack[i]\n      if (item.id === id) {\n        return\n      }\n    }\n\n    const modalDom = getModal()\n\n    addClass(modalDom, 'v-modal')\n    if (this.modalFade && !hasModal) {\n      addClass(modalDom, 'v-modal-enter')\n    }\n    if (modalClass) {\n      const classArr = modalClass.trim().split(/\\s+/)\n      classArr.forEach((item) => addClass(modalDom, item))\n    }\n    setTimeout(() => {\n      removeClass(modalDom, 'v-modal-enter')\n    }, 200)\n\n    if (dom && dom.parentNode && dom.parentNode.nodeType !== 11) {\n      dom.parentNode.appendChild(modalDom)\n    } else {\n      document.body.appendChild(modalDom)\n    }\n\n    if (zIndex) {\n      modalDom.style.zIndex = String(zIndex)\n    }\n    modalDom.tabIndex = 0\n    modalDom.style.display = ''\n\n    this.modalStack.push({ id, zIndex, modalClass })\n  },\n\n  closeModal(id) {\n    const modalStack = this.modalStack\n    const modalDom = getModal()\n\n    if (modalStack.length > 0) {\n      const topItem = modalStack[modalStack.length - 1]\n      if (topItem.id === id) {\n        if (topItem.modalClass) {\n          const classArr = topItem.modalClass.trim().split(/\\s+/)\n          classArr.forEach((item) => removeClass(modalDom, item))\n        }\n\n        modalStack.pop()\n        if (modalStack.length > 0) {\n          modalDom.style.zIndex = modalStack[modalStack.length - 1].zIndex\n        }\n      } else {\n        for (let i = modalStack.length - 1; i >= 0; i--) {\n          if (modalStack[i].id === id) {\n            modalStack.splice(i, 1)\n            break\n          }\n        }\n      }\n    }\n\n    if (modalStack.length === 0) {\n      if (this.modalFade) {\n        addClass(modalDom, 'v-modal-leave')\n      }\n      setTimeout(() => {\n        if (modalStack.length === 0) {\n          if (modalDom.parentNode) modalDom.parentNode.removeChild(modalDom)\n          modalDom.style.display = 'none'\n          // off(modalDom, 'touchmove', onTouchMove)\n          // off(modalDom, 'click', onModalClick)\n          PopupManager.modalDom = undefined\n        }\n        removeClass(modalDom, 'v-modal-leave')\n      }, 200)\n    }\n  },\n}\n\nObject.defineProperty(PopupManager, 'zIndex', {\n  configurable: true,\n  get() {\n    if (zIndex === undefined) {\n      zIndex = (configs.getConfig('zIndex') as number) || 2000\n    }\n    return zIndex\n  },\n  set(value) {\n    zIndex = value\n  },\n})\n\nconst getTopPopup = function () {\n  if (isServer) return\n  if (PopupManager.modalStack.length > 0) {\n    const topPopup = PopupManager.modalStack[PopupManager.modalStack.length - 1]\n    if (!topPopup) return\n    const instance = PopupManager.getInstance(topPopup.id)\n\n    return instance\n  }\n}\n\nif (!isServer) {\n  // handle `esc` key when the popup is shown\n  on(window, 'keydown', function (event: KeyboardEvent) {\n    if (event.code === EVENT_CODE.esc) {\n      const topPopup = getTopPopup()\n\n      if (topPopup && topPopup.closeOnPressEscape.value) {\n        topPopup.handleClose\n          ? topPopup.handleClose()\n          : topPopup.handleAction\n          ? topPopup.handleAction('cancel')\n          : topPopup.close()\n      }\n    }\n  })\n}\n\nexport default PopupManager\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}